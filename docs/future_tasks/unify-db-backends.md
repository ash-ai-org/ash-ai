# Unify SQLite and PG Database Backends with Drizzle ORM

## Status: Done

## Problem

`packages/server/src/db/sqlite.ts` and `packages/server/src/db/pg.ts` were ~480 and ~460 lines each with ~90% identical logic. The only real differences were:

- Placeholder syntax (`?` vs `$1, $2`)
- Sync vs async query execution
- Date defaults (`datetime('now')` vs `now()::TEXT`)
- Migration syntax (try/catch vs `IF NOT EXISTS` for ALTER TABLE)

All SQL queries and row-to-object mapping were duplicated verbatim. Migrations were inline and fragile.

## Solution: Drizzle ORM

Replaced both hand-rolled DB implementations with Drizzle ORM. Single `DrizzleDb` class implements the `Db` interface for both SQLite and PostgreSQL.

### Why Drizzle over Prisma

- **No binary engine** — Drizzle is pure TypeScript, no 15-30MB Rust query engine
- **Dialect-native schemas** — `sqliteTable` / `pgTable` use the actual SQL types
- **No codegen step** — schema files are plain TypeScript, imported directly
- **SQL-close API** — `.select().from().where()` maps 1:1 to SQL, easy to audit
- **Migration files are plain SQL** — generated by `drizzle-kit`, committed and shipped

### What Changed

| Action | File | Notes |
|--------|------|-------|
| New | `src/db/schema.sqlite.ts` | 6 tables, SQLite dialect |
| New | `src/db/schema.pg.ts` | 6 tables, PG dialect |
| New | `src/db/drizzle-db.ts` | Single `DrizzleDb` class implementing `Db` |
| New | `drizzle.config.sqlite.ts` | Drizzle Kit config for SQLite |
| New | `drizzle.config.pg.ts` | Drizzle Kit config for PG |
| New | `drizzle/sqlite/0000_*.sql` | Generated initial SQLite migration |
| New | `drizzle/pg/0000_*.sql` | Generated initial PG migration |
| Modified | `src/db/index.ts` | `initDb()` now creates Drizzle instances |
| Modified | `package.json` | Added drizzle-orm, drizzle-kit, db:generate scripts |
| Deleted | `src/db/sqlite.ts` | -479 lines |
| Deleted | `src/db/pg.ts` | -460 lines |
| Deleted | `src/db/schema.sql` | Drizzle schema is now source of truth |
| Deleted | `src/db/dump-schema.ts` | No longer needed |
| Deleted | `scripts/dump-schema.ts` | No longer needed |
| Deleted | `src/__tests__/schema.test.ts` | No longer needed |

### Existing Databases

Drizzle's `migrate()` creates a `__drizzle_migrations` tracking table. The initial migration uses `CREATE TABLE IF NOT EXISTS` (SQLite) / plain `CREATE TABLE` (PG) — for existing databases, the migration is applied idempotently by Drizzle's journal tracking.

### Zero Consumer Impact

The `Db` interface and all re-exported free functions in `db/index.ts` are unchanged. All 122 existing tests pass without modification.
