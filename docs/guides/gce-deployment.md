# Deploying Ash to GCP Compute Engine

Deploy the Ash server to a Google Cloud Compute Engine instance. Once running, you can deploy agents, create sessions, and connect the example QA Bot UI from your local machine.

## Prerequisites

- **gcloud CLI** installed and authenticated ([install guide](https://cloud.google.com/sdk/docs/install))
- **A GCP project** with the Compute Engine API enabled
- **Anthropic API key** for agent execution
- **Node.js >= 20** and **pnpm** (for running the QA Bot UI locally)

## Quick Start

```bash
# 1. Clone and set up
git clone https://github.com/ash-ai/ash.git
cd ash

# 2. Configure credentials
cp .env.example .env
# Edit .env — fill in ANTHROPIC_API_KEY and GCP_PROJECT_ID

# 3. Deploy to GCE
./scripts/deploy-gce.sh

# 4. Run the smoke test
./scripts/smoke-test-ec2.sh http://<your-gce-ip>:4100

# 5. Run the benchmark
npx tsx test/bench/remote-latency.ts --url http://<your-gce-ip>:4100

# 6. Connect the QA Bot UI to your GCE server
ASH_SERVER_URL=http://<your-gce-ip>:4100 pnpm --filter qa-bot dev
# Open http://localhost:3100

# 7. When done, tear down
./scripts/teardown-gce.sh
```

## Configuration

### Required Variables

| Variable | Description | Example |
|----------|-------------|---------|
| `ANTHROPIC_API_KEY` | Anthropic API key for agent execution | `sk-ant-...` |
| `GCP_PROJECT_ID` | GCP project ID (or set via `gcloud config set project`) | `my-project-123` |

### Optional Variables

| Variable | Default | Description |
|----------|---------|-------------|
| `GCP_ZONE` | `us-east1-b` | Compute Engine zone |
| `GCP_MACHINE_TYPE` | `e2-standard-2` | Machine type (2 vCPU, 8GB RAM) |
| `GCP_DISK_SIZE` | `30` | Boot disk size in GB (SSD) |
| `ASH_PORT` | `4100` | Port the Ash API listens on |

### GCP Setup From Scratch

If you haven't used GCP before, here's everything you need to do. GCP is simpler than AWS for this use case — no key pairs, no IAM access keys. Authentication is handled entirely through `gcloud auth login`.

#### 1. Create a GCP Account and Project

1. Go to [console.cloud.google.com](https://console.cloud.google.com)
2. Sign in with your Google account (new accounts get $300 free credits)
3. Create a new project (or use an existing one)
4. Note your **Project ID** (not the project name — it's the ID shown under the project name, e.g. `my-project-123456`)

#### 2. Install the gcloud CLI

```bash
# macOS (Homebrew)
brew install --cask google-cloud-sdk

# macOS (manual — if Homebrew doesn't work)
# Download from https://cloud.google.com/sdk/docs/install
# Extract and run ./google-cloud-sdk/install.sh

# Linux (Debian/Ubuntu)
curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo gpg --dearmor -o /usr/share/keyrings/cloud.google.gpg
echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
sudo apt-get update && sudo apt-get install google-cloud-cli
```

Verify it's installed:

```bash
gcloud --version
```

#### 3. Authenticate

```bash
gcloud auth login
```

This opens a browser window. Sign in with the same Google account that owns your GCP project. The CLI stores the credentials locally — no API keys or secrets to manage.

If your tokens expire later (you'll see `Reauthentication failed` errors), just run `gcloud auth login` again.

#### 4. Set Your Project

```bash
gcloud config set project YOUR_PROJECT_ID
```

Or set `GCP_PROJECT_ID` in your `.env` file. The deploy script checks both.

Verify it's set:

```bash
gcloud config get-value project
# Should print your project ID
```

#### 5. Enable the Compute Engine API

```bash
gcloud services enable compute.googleapis.com
```

This takes ~30 seconds. You only need to do this once per project. If you skip this, the deploy script will fail with `Compute Engine API not enabled`.

#### 6. Enable Billing

Compute Engine requires a billing account. If you haven't set one up:

1. Go to [console.cloud.google.com/billing](https://console.cloud.google.com/billing)
2. Create a billing account (or link an existing one)
3. Link it to your project

New accounts get $300 in free credits, more than enough for testing.

#### 7. Verify Everything Works

```bash
# Should print your project ID
gcloud config get-value project

# Should list Compute Engine as enabled
gcloud services list --enabled --filter="name:compute.googleapis.com"

# Should show your authenticated account
gcloud auth list
```

If all three commands work, you're ready to deploy.

### Key Difference From AWS

With AWS, you need to manage IAM access keys (`AWS_ACCESS_KEY_ID`, `AWS_SECRET_ACCESS_KEY`) and SSH key pairs (`EC2_KEY_NAME`, `EC2_KEY_PATH`). With GCP, authentication is handled entirely by `gcloud auth login` and SSH keys are auto-generated by `gcloud compute ssh`. The only credential you need in `.env` is `ANTHROPIC_API_KEY`.

## What the Deploy Script Does

`scripts/deploy-gce.sh` automates the full deployment:

1. **Creates a firewall rule** (if not exists) allowing TCP port 4100 tagged `ash-server`
2. **Launches an `e2-standard-2` VM** with Ubuntu 22.04 LTS and a startup script that installs Docker, Node.js 20, and pnpm
3. **Waits for the VM** to be SSH-ready and setup to complete (~2 minutes)
4. **Syncs the project** to the VM via `gcloud compute scp` (tarball transfer)
5. **Builds the Docker image** on the VM (~3-5 minutes)
6. **Starts the Ash container** with `--privileged` (for cgroup v2 sandbox resource limits) and your `ANTHROPIC_API_KEY`
7. **Deploys the `qa-bot` example agent** via the REST API
8. **Prints the connection URL** and next steps

State is saved to `.gce-instance` so `teardown-gce.sh` knows what to clean up.

## Connecting the QA Bot Example

```bash
ASH_SERVER_URL=http://<your-gce-ip>:4100 pnpm --filter qa-bot dev
```

Open http://localhost:3100 in your browser.

## Using the SDK

```typescript
import { AshClient } from '@ash-ai/sdk';

const client = new AshClient({
  serverUrl: 'http://<your-gce-ip>:4100',
});

const session = await client.createSession('qa-bot');
for await (const event of client.sendMessageStream(session.id, 'Hello!')) {
  if (event.type === 'message') {
    console.log(event.data);
  }
}
await client.endSession(session.id);
```

## Deploying Your Own Agent

```bash
# Get the GCE IP
source .gce-instance

# Copy agent to the instance
gcloud compute scp --recurse ./my-agent $INSTANCE_NAME:~/.ash/agents/my-agent \
  --zone=$GCP_ZONE

# Register it with the server
curl -X POST "http://$PUBLIC_IP:4100/api/agents" \
  -H "Content-Type: application/json" \
  -d '{"name":"my-agent","path":"agents/my-agent"}'
```

## Running the Remote Benchmark

```bash
npx tsx test/bench/remote-latency.ts --url http://<your-gce-ip>:4100 --rounds 5
```

## Monitoring

```bash
# SSH into the instance
gcloud compute ssh ash-server --zone=us-east1-b

# View server logs
gcloud compute ssh ash-server --zone=us-east1-b --command='docker logs -f ash-server'

# Health check
curl http://<your-gce-ip>:4100/health
```

## Troubleshooting

### "Reauthentication failed" or "There was a problem refreshing your current auth tokens"

Your gcloud credentials have expired. Re-authenticate:

```bash
gcloud auth login
```

This opens a browser. Complete the sign-in and the CLI will store fresh tokens. This is the most common issue — gcloud tokens expire periodically and there's no way to avoid it.

If you get a `400` error in the browser during auth, close the tab, wait 10 seconds, and run `gcloud auth login` again. The local redirect server sometimes conflicts with a previous attempt.

### "Compute Engine API not enabled"

```bash
gcloud services enable compute.googleapis.com
```

This only needs to be done once per project. Takes ~30 seconds.

### "Billing account not configured"

Compute Engine requires billing. Go to [console.cloud.google.com/billing](https://console.cloud.google.com/billing), create or link a billing account, then link it to your project.

### "Connection refused" from local machine

Check that the firewall rule exists and the instance has the `ash-server` tag:

```bash
gcloud compute firewall-rules list --filter="name=allow-ash-api"
gcloud compute instances describe ash-server --zone=us-east1-b --format='get(tags.items)'
```

If the firewall rule is missing, the teardown script may have deleted it. Re-run the deploy script.

### "Setup did not complete within 5 minutes"

SSH in and check the startup script log:

```bash
gcloud compute ssh ash-server --zone=us-east1-b
sudo journalctl -u google-startup-scripts.service -f
```

Common causes:
- Slow package mirror (retry usually works)
- Node.js 20 repo unreachable (check `curl -fsSL https://deb.nodesource.com/setup_20.x` from the VM)

### "Permission denied" connecting to Docker

The deploy script uses `sudo docker` because the `usermod -aG docker` command (run during VM startup) requires a new login session to take effect. If you SSH in manually, either use `sudo docker` or run `newgrp docker` first.

### WASM OOM errors

Ensure the container runs with `--privileged` (the deploy script does this automatically). Without it, ulimit-based memory limits restrict virtual address space (`ulimit -v`), which kills WASM instantiation even on machines with plenty of RAM. The `--privileged` flag allows cgroup v2 setup, which limits RSS (physical memory) instead of virtual address space.

### Instance already exists

```
Error: Instance state file exists at .gce-instance
```

Either a previous deployment is still running, or a failed deploy left a stale state file. Check if the instance actually exists:

```bash
gcloud compute instances describe ash-server --zone=us-east1-b 2>&1
```

If it exists, tear it down first: `./scripts/teardown-gce.sh`. If it doesn't exist, delete the stale state file: `rm .gce-instance`.

## Tearing Down

```bash
./scripts/teardown-gce.sh
```

This deletes the VM instance and the `allow-ash-api` firewall rule. The `.gce-instance` state file is removed.

## Cost

| Resource | Approximate Cost |
|----------|-----------------|
| `e2-standard-2` (2 vCPU, 8GB) | ~$0.067/hour (~$49/month) |
| 30 GB SSD persistent disk | ~$5.10/month |

Remember to run `./scripts/teardown-gce.sh` when you're done to avoid ongoing charges.

## EC2 vs GCE Comparison

| | EC2 (AWS) | Compute Engine (GCP) |
|--|-----------|---------------------|
| CLI | `aws` | `gcloud` |
| SSH | Manual key pair (`EC2_KEY_NAME`) | Automatic via `gcloud compute ssh` |
| Firewall | Security Groups | Firewall Rules + network tags |
| Default type | `t3.large` (2 vCPU, 8GB) | `e2-standard-2` (2 vCPU, 8GB) |
| Cost/hour | ~$0.083 | ~$0.067 |
| Deploy script | `scripts/deploy-ec2.sh` | `scripts/deploy-gce.sh` |
